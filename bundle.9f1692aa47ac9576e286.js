(()=>{"use strict";var e={187:e=>{var t,n="object"==typeof Reflect?Reflect:null,r=n&&"function"==typeof n.apply?n.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,e.exports.once=function(e,t){return new Promise((function(n,r){function s(n){e.removeListener(t,o),r(n)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",s),n([].slice.call(arguments))}y(e,t,o,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&y(e,"error",t,n)}(e,s,{once:!0})}))},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var i=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function c(e,t,n,r){var s,o,i,c;if(a(n),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),i=o[t]),void 0===i)i=o[t]=n,++e._eventsCount;else if("function"==typeof i?i=o[t]=r?[n,i]:[i,n]:r?i.unshift(n):i.push(n),(s=l(e))>0&&i.length>s&&!i.warned){i.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=i.length,c=u,console&&console.warn&&console.warn(c)}return e}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},s=u.bind(r);return s.listener=n,r.wrapFn=s,s}function d(e,t,n){var r=e._events;if(void 0===r)return[];var s=r[t];return void 0===s?[]:"function"==typeof s?n?[s.listener||s]:[s]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(s):v(s,s.length)}function f(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function v(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function y(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function s(o){r.once&&e.removeEventListener(t,s),n(o)}))}}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return i},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");i=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return l(this)},o.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s="error"===e,o=this._events;if(void 0!==o)s=s&&void 0===o.error;else if(!s)return!1;if(s){var i;if(t.length>0&&(i=t[0]),i instanceof Error)throw i;var a=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw a.context=i,a}var l=o[e];if(void 0===l)return!1;if("function"==typeof l)r(l,this,t);else{var c=l.length,u=v(l,c);for(n=0;n<c;++n)r(u[n],this,t)}return!0},o.prototype.addListener=function(e,t){return c(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return c(this,e,t,!0)},o.prototype.once=function(e,t){return a(t),this.on(e,h(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,h(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,r,s,o,i;if(a(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(s=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){i=n[o].listener,s=o;break}if(s<0)return this;0===s?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,s),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,i||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var s,o=Object.keys(n);for(r=0;r<o.length;++r)"removeListener"!==(s=o[r])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},o.prototype.listeners=function(e){return d(this,e,!0)},o.prototype.rawListeners=function(e){return d(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},o.prototype.listenerCount=f,o.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}}},t={};function n(r){var s=t[r];if(void 0!==s)return s.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,n),o.exports}(()=>{const e=(t,n,r)=>{const s=Math.floor(Math.random()*(n-t+1)+t);return(null==r?void 0:r.exclude.includes(s))?e(t,n,r):s},t=function*(e,t,n=1){let r=void 0!==t?e:0,s=void 0!==t?t:e;const o=Math.sign(n)<0;o&&([r,s]=[s-1,r-1]);for(let e=r;o?e>s:e<s;e+=n)yield e},r=(e,t)=>e.x+e.y*t;function*s(e,n="x",s){const o=e.length;for(const i of t(o))for(const a of t(0,o,s?-1:1)){const[t,s]="x"===n?[a,i]:[i,a],l=e[s][t],c=r({x:t,y:s},o);yield{value:l,x:t,y:s,index:c}}}const o=e=>new Promise((t=>setTimeout(t,e)));var i,a=n(187);class l{constructor(e){this.boardSize=e,this.state={cells:[]},this.ee=new a.EventEmitter}onUpdate(e){this.ee.addListener(l.UPDATE_EVENT,(t=>e(this.state,t)))}onCellsMerge(e){this.ee.addListener(l.MERGE_EVENT,(t=>e(t)))}restore(e){this.setState({cells:e})}reset(){this.setState({cells:[]})}move(e,t){var n;const r=this.boardSize;let o=!1;const i=this.getBoardMatrix(),a=new Set;for(const{value:l,x:c,y:u}of s(i,e,Math.sign(t)>0)){if(!l)continue;const s=e=>Math.sign(t)>0?e<r-1:e>0;for(let r="x"===e?c:u;s(r);r+=t){const s="x"===e?{y:u,x:r}:{y:r,x:c},h="x"===e?{y:u,x:r+t}:{y:r+t,x:c},d=null===(n=i[h.y])||void 0===n?void 0:n[h.x];if(null!==d){if(d.value===l.value&&!a.has(l.key)&&!a.has(d.key)){l.doubleValue(),i[h.y][h.x]=l,i[s.y][s.x]=null,a.add(l.key),o=!0;break}break}[i[s.y][s.x],i[h.y][h.x]]=[i[h.y][h.x],i[s.y][s.x]],o=!0}}if(o){const e=Array.from(s(i)).filter((({value:e})=>null!==e)).map((({value:e,x:t,y:n})=>(null==e||e.setCoords({x:t,y:n}),e)));a.forEach((t=>{this.ee.emit(l.MERGE_EVENT,e.find((e=>e.key===t)))})),this.setState({cells:e})}return o}setState(e){const t=this.state;this.state=Object.assign(Object.assign({},t),e),this.ee.emit(l.UPDATE_EVENT,t)}getBoardMatrix(){var e;const n=this.boardSize,r=this.state.cells,s=Array.from({length:n}).map((()=>Array.from({length:n})));for(const n of t(s.length))for(const o of t(s.length))s[o][n]=null!==(e=r.find((e=>e.x===n&&e.y===o)))&&void 0!==e?e:null;return s}spawnCells(n){const s=this.boardSize,o=[...this.state.cells],i=()=>{const t=o.map((e=>r(e.coords,s))),n=((e,t)=>({x:e%t,y:Math.floor(e/t)}))(e(0,Math.pow(s,2)-1,{exclude:t}),s);return new c(n,2)};Array.from(t(n)).forEach((()=>o.push(i()))),this.setState({cells:o})}}l.UPDATE_EVENT="STATE_CHANGED_EVENT",l.MERGE_EVENT="CELLS_MERGE_EVENT";class c{constructor(e,t){this.value=t,this.key=null,this.x=null,this.y=null,this.validateValue(t),this.x=e.x,this.y=e.y,this.key="_"+Math.random().toString(36).slice(2,9)}doubleValue(){this.value=2*this.value}setCoords(e){this.x=e.x,this.y=e.y}get coords(){return{x:this.x,y:this.y}}validateValue(e){if(!(e=>Math.log(e)/Math.log(2)%1==0)(e))throw TypeError("Value must be a power of 2")}}!function(e){e[e.LEFT=0]="LEFT",e[e.UP=1]="UP",e[e.RIGHT=2]="RIGHT",e[e.DOWN=3]="DOWN"}(i||(i={}));class u{constructor(e){this.boardElement=e,this.KEY_MAP={w:i.UP,ArrowUp:i.UP,s:i.DOWN,ArrowDown:i.DOWN,a:i.LEFT,ArrowLeft:i.LEFT,d:i.RIGHT,ArrowRight:i.RIGHT}}listenCommand(e){const t=this.keysListen(e),n=this.gestureListen(e);return{unsubscribe:()=>{t(),n()}}}keysListen(e){const t=t=>{const n=this.KEY_MAP[t.key];void 0!==n&&e(n,t)};return document.addEventListener("keydown",t),()=>{document.removeEventListener("keydown",t)}}gestureListen(e){let t=0,n=0;const r=e=>(t=e.changedTouches[0].screenX,n=e.changedTouches[0].screenY,e.stopPropagation(),e.preventDefault(),!1),s=r=>{const s=r.changedTouches[0].screenX,o=r.changedTouches[0].screenY,a=Math.abs(s-t),l=Math.abs(o-n);a<10&&l<10||e(a>l?s<t?i.LEFT:i.RIGHT:o<n?i.UP:i.DOWN,r)};return this.boardElement.addEventListener("touchstart",r,{passive:!0}),this.boardElement.addEventListener("touchend",s,{passive:!0}),()=>{this.boardElement.removeEventListener("touchstart",r),this.boardElement.removeEventListener("touchend",s)}}}class h{constructor(e,t){this.key=e,this.transforms=t}save(e){var t;const n=Object.assign({},e);Object.entries(null!==(t=this.transforms)&&void 0!==t?t:[]).forEach((([e,[t]])=>{n[e]&&(n[e]=t(n[e]))})),localStorage.setItem(this.key,JSON.stringify(n))}load(){var e;const t=this.loadJson();return t?(Object.entries(null!==(e=this.transforms)&&void 0!==e?e:[]).forEach((([e,[,n]])=>{t[e]&&(t[e]=n(t[e]))})),t):null}clear(){localStorage.removeItem(this.key)}loadJson(){try{return JSON.parse(localStorage.getItem(this.key))}catch(e){return null}}}class d{constructor(e,t){this.boardElement=e,this.boardSize=t,this.renderCleanup=[],this.boardGridElement=null,this.boardSceneElement=null,this.createHooks=()=>{this.renderCleanup.forEach((e=>e())),this.renderCleanup=[];return{afterTransition:e=>{const t=window.setTimeout(e,d.MOVE_TRANSITION_MS);this.renderCleanup.push((()=>clearTimeout(t)))}}},this.boardGridElement=e.querySelector(".board-grid"),this.boardSceneElement=e.querySelector(".board-scene")}static getCSSVar(e){return getComputedStyle(document.documentElement).getPropertyValue(e)}static setCSSVar(e,t){return document.documentElement.style.setProperty(e,t)}mount(){const e=`calc(var(${d.BOARD_SIZE_VAR}) / ${this.boardSize})`,n=`calc(var(${d.CELL_SIZE_VAR}) * 0.03) `;d.setCSSVar(d.CELL_SIZE_VAR,e),d.setCSSVar(d.CELL_GAP_VAR,n);this.boardGridElement.replaceChildren(...Array.from(t(Math.pow(this.boardSize,2))).map((()=>(()=>{const e=document.createElement("div");return e.classList.add("cell","cell-empty"),e})())))}static createCellElement(e){return d.updateCellElement(e,document.createElement("div"))}static updateCellElement(e,t){t.className="",t.classList.add("cell","cell-filled",`cell-${e.value}`),t.setAttribute("data-key",e.key);const n=`calc(var(${d.CELL_SIZE_VAR}) + var(${d.CELL_GAP_VAR}) * 0.25)`,r=`calc(${n} * ${e.x})`,s=`calc(${n} * ${e.y})`;return t.style.transform="",t.style.top=s,t.style.left=r,t.innerHTML=String(e.value),t}getSceneCellElements(){return Array.from(this.boardElement.querySelectorAll(".board-scene .cell"))}render(e){const t=this.createHooks(),n=this.getSceneCellElements(),r=new Set(e.map((e=>e.key))),s=e=>String(e.getAttribute("data-key")),o=e=>n.find((t=>s(t)===e));if(!n.length)return void this.boardSceneElement.replaceChildren(...e.map((e=>d.createCellElement(e))));for(const n of e){const e=o(n.key);if(e)d.updateCellElement(n,e);else{const e=d.createCellElement(n);t.afterTransition((()=>this.boardSceneElement.append(e)))}}const i=n.filter((e=>!r.has(s(e))));for(const e of i)e.remove()}}d.CELL_GAP_VAR="--cell-gap",d.CELL_SIZE_VAR="--cell-size",d.BOARD_SIZE_VAR="--board-size",d.MOVE_TRANSITION_MS=100;var f=function(e,t,n,r){return new(n||(n=Promise))((function(s,o){function i(e){try{l(r.next(e))}catch(e){o(e)}}function a(e){try{l(r.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}l((r=r.apply(e,t||[])).next())}))};let v=!1;const y=e=>f(void 0,void 0,void 0,(function*(){if(!v){v=!0;const t=yield e();return v=!1,t}})),m=document.getElementById("board-root"),p=document.getElementById("score-value");new class{constructor(e){this.cfg=e,this.storage=new h("game-state.v1",{cells:[e=>null==e?void 0:e.map((({x:e,y:t,value:n})=>({x:e,y:t,value:n}))),e=>null==e?void 0:e.map((({x:e,y:t,value:n})=>new c({x:e,y:t},n)))]})}get state(){const e=this.storage.load(),t={boardSize:this.cfg.boardSize,cells:[],score:0,afterPartyMode:!1};return this._state?Object.assign(Object.assign({},t),this._state):e||t}setState(e){const t=Object.assign(Object.assign({},this.state),e);this.storage.save(t),this._state=t}bootstrap(){const e=document.getElementById("reset-button"),t=document.getElementById("current-score-value"),n=new u(this.cfg.boardElement),r=new d(this.cfg.boardElement,this.state.boardSize),s=new l(this.state.boardSize),a={[i.UP]:()=>s.move("y",-1),[i.DOWN]:()=>s.move("y",1),[i.LEFT]:()=>s.move("x",-1),[i.RIGHT]:()=>s.move("x",1)},c=()=>{this.setState({cells:[],score:0,afterPartyMode:!1}),s.reset(),s.spawnCells(2),t.innerHTML=String(this.state.score)};s.onCellsMerge((e=>{const n=this.state.score+e.value;this.setState({score:n}),t.innerHTML=String(n)})),s.onUpdate((({cells:e})=>(r.render(e),this.isGameOver(e)?y((()=>o(300).then((()=>{alert("Game Over!"),c()})))):this.isWin(e)&&!this.state.afterPartyMode?y((()=>o(300).then((()=>{confirm("You just reached the 2048 🎉🎉🎉. Do you want to continue?")?this.setState({afterPartyMode:!0}):c()})))):void this.setState({cells:e})))),e.addEventListener("click",(()=>c())),n.listenCommand((e=>{(0,a[e])()&&s.spawnCells(1)})),this.state.cells.length>0?s.restore(this.state.cells):c(),r.mount(),t.innerHTML=String(this.state.score)}isWin(e){return e.some((e=>2048===e.value))}isGameOver(e){const t=e=>`${e.x}x${e.y}`;if(!(e.length===Math.pow(this.cfg.boardSize,2)))return!1;const n=e.reduce(((e,n)=>(e[t(n.coords)]=n,e)),{});return e.every((e=>[n[t({x:e.x+1,y:e.y})],n[t({x:e.x-1,y:e.y})],n[t({x:e.x,y:e.y+1})],n[t({x:e.x,y:e.y-1})]].every((t=>!t||t.value!==e.value))))}}({scoreValueElement:p,boardElement:m,boardSize:4}).bootstrap(),"serviceWorker"in navigator&&navigator.serviceWorker.register("./service-worker.js")})()})();
//# sourceMappingURL=bundle.9f1692aa47ac9576e286.js.map